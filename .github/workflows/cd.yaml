name: CD

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]
#to run this cd workflow only if ci workflow is successful
jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: [self-hosted, linux]
    steps:
      - name: Deploy to EC2 via SSH and Docker
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.EC2_SSH_PORT }}
          script: |
            set -e
            # optional: login to Docker Hub if image is private
            if [ -n "${{ secrets.DOCKER_USERNAME }}" ] && [ -n "${{ secrets.DOCKER_PASSWORD }}" ]; then
              echo "Logging in to Docker Hub"
              echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin || true
            fi

            IMAGE=imharry404/react-vite-githubactions-aws:latest
            echo "Pulling $IMAGE"
            docker pull $IMAGE

            echo "Stopping existing container (if any)"
            docker stop hello-react || true
            docker rm hello-react || true

            echo "Starting container"
            docker run -d --name hello-react -p 80:80 --restart=always $IMAGE
