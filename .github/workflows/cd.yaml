name: CD - deploy to EC2

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: [self-hosted, linux]
    steps:
      - name: Validate SSH credentials
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          if [ -z "$SSH_PRIVATE_KEY" ] && [ -z "$SSH_PASSWORD" ]; then
            echo "ERROR: Missing secrets. Set repository secrets 'SSH_PRIVATE_KEY' (preferred) or 'SSH_PASSWORD'."
            exit 1
          fi
      - name: print and resolve EC2 host
        run: |
          echo "EC2_HOST (secret) = '${{ secrets.EC2_HOST }}'"
          if command -v dig >/dev/null 2>&1; then
            dig +short "${{ secrets.EC2_HOST }}" || true
          else
            ping -c 1 "${{ secrets.EC2_HOST }}" || true
          fi

      - name: Prepare SSH private key file
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          if [ -z "$SSH_PRIVATE_KEY" ]; then
            echo "No SSH_PRIVATE_KEY provided; skipping key write"
            exit 0
          fi
          echo "Writing SSH private key to runner temp"
          echo "Runner temp: $RUNNER_TEMP"
          mkdir -p "$RUNNER_TEMP"
          printf "%s" "$SSH_PRIVATE_KEY" > "$RUNNER_TEMP/deploy_key"
          chmod 600 "$RUNNER_TEMP/deploy_key"

      - name: Deploy to EC2 via SSH and Docker
        uses: appleboy/ssh-action@v0.1.8
        with:
          debug: true
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key_path: ${{ runner.temp }}/deploy_key
          port: ${{ secrets.EC2_SSH_PORT }}
          script: |
            set -e
            # optional: login to Docker Hub if image is private
            if [ -n "${{ secrets.DOCKER_USERNAME }}" ] && [ -n "${{ secrets.DOCKER_PASSWORD }}" ]; then
              echo "Logging in to Docker Hub"
              echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin || true
            fi

            # Prefer deploying the image pushed by CI with the commit SHA tag
            IMAGE=imharry404/react-vite-githubactions-aws:${{ github.event.workflow_run.head_sha }}
            echo "Deploying image tag: ${IMAGE}"
            echo "Pulling $IMAGE"
            docker pull $IMAGE

            echo "Stopping existing container (if any)"
            docker stop hello-react || true
            docker rm hello-react || true

            echo "Starting container"
            docker run -d --name hello-react -p 80:80 --restart=always $IMAGE

            # Wait for the service to become healthy (attempt up to 30s)
            echo "Waiting for service to respond on http://localhost:80"
            for i in 1 2 3 4 5 6; do
              if curl -sSf http://localhost:80 >/dev/null; then
                echo "Service is up"
                break
              else
                echo "Service not ready yet, retrying... ($i)"
                sleep 5
              fi
            done
            if ! curl -sSf http://localhost:80 >/dev/null; then
              echo "ERROR: Service did not become ready"
              exit 1
            fi

      - name: remove temporary SSH key
        run: |
          if [ -n "$RUNNER_TEMP" ] && [ -f "$RUNNER_TEMP/deploy_key" ]; then
            echo "Removing key from $RUNNER_TEMP/deploy_key"
            rm -f "$RUNNER_TEMP/deploy_key" || true
          else
            echo "No temporary key to remove"
          fi